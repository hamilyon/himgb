results n=40 commit 7975e4191529558ffa0cb1b7dca0e29fd79af2f5
Stats {overallSpam = 0, overallHam = 0, detectedSpamOk = 21, detectedHamOk = 88, detectedFalseSpam = 19, detecteFalseHam = 2}


n = 15
*CheckTrained System.Time> System.Time.getClockTime 
Tue May 22 08:57:15 MSD 2012
*CheckTrained System.Time> checkTrained
Stats {overallSpam = 0, overallHam = 0, detectedSpamOk = 10, detectedHamOk = 90, detectedFalseSpam = 5, detecteFalseHam = 0}
*CheckTrained System.Time> System.Time.getClockTime 
Tue May 22 09:07:35 MSD 2012 - 5 минут примерно


-- ! trains too slow

-- now trains offline

(putStr =<< (show `fmap` System.Time.getClockTime))  >> 
(putStr =<< ((take 1) . reverse . show) `fmap` loadTrained) >> 
System.Time.getClockTime


результат на  6c1a1f6fbaaa5a951828fcbe8661583fdb0d5623

где-то за 5 секунд
overallSpam = 1694, overallHam = 90
detectedSpamOk = 1255, detectedHamOk = 76, detectedFalseSpam = 439, detecteFalseHam = 14 (толерантность 0.1)

в целом, неуд, но не факт, что виноват алгоритм, не исключено, что это 
примеры для обучения



---- обучение на 240 строках 
- не дождался, минут 3-5 ждал

-- на 40 -ка

исправил баг в измерялке - она не просила фактичесекие результаты, обучаю на разных объёмах

hamilyon@coordinator:~/re/freb$ ./Measure 
warming up
estimating clock resolution...
mean is 11.26505 us (80001 iterations)
found 6196 outliers among 79999 samples (7.7%)
  2882 (3.6%) high mild
  3310 (4.1%) high severe
estimating cost of a clock call...
mean is 822.8862 ns (100 iterations)
found 1 outliers among 100 samples (1.0%)

benchmarking learn/learn 1000000
Stack space overflow: current size 8388608 bytes.
Use `+RTS -Ksize -RTS' to increase it.

------------
getWordSpamminess :: [String] -> Map.Map String Double -> Map.Map String Double
getWordSpamminess   []       mapSoFar = mapSoFar
getWordSpamminess   (x:xs)   mapSoFar = 
        getWordSpamminess xs (Map.insertWith (+) x 1 mapSoFar)



hamilyon@coordinator:~/re/freb$ ./Measure +RTS -sstderr -K100M
./Measure +RTS -sstderr -K100M 
warming up
estimating clock resolution...
mean is 10.79401 us (80001 iterations)
found 5208 outliers among 79999 samples (6.5%)
  2429 (3.0%) high mild
  2778 (3.5%) high severe
estimating cost of a clock call...
mean is 757.5467 ns (66 iterations)
found 11 outliers among 66 samples (16.7%)
  1 (1.5%) low severe
  5 (7.6%) low mild
  3 (4.5%) high mild
  2 (3.0%) high severe

benchmarking learn/learn 10000
collecting 100 samples, 1 iterations each, in estimated 713.6230 s
mean: 7.315075 s, lb 7.265887 s, ub 7.364078 s, ci 0.950
std dev: 252.9486 ms, lb 222.5831 ms, ub 289.6359 ms, ci 0.950
  66,993,894,944 bytes allocated in the heap
  64,594,786,776 bytes copied during GC
     160,046,480 bytes maximum residency (386 sample(s))
       4,495,336 bytes maximum slop
             413 MB total memory in use (0 MB lost due to fragmentation)

  Generation 0: 121608 collections,     0 parallel, 83.64s, 84.16s elapsed
  Generation 1:   386 collections,     0 parallel, 46.21s, 60.68s elapsed

  INIT  time    0.00s  (  0.00s elapsed)
  MUT   time  579.07s  (598.22s elapsed)
  GC    time  129.85s  (144.84s elapsed)
  EXIT  time    0.00s  (  0.00s elapsed)
  Total time  708.92s  (743.06s elapsed)

  %GC time      18.3%  (19.5% elapsed)

  Alloc rate    115,692,221 bytes per MUT second

  Productivity  81.7% of total user, 77.9% of total elapsed


25000:

hamilyon@coordinator:~/re/freb$ time ./Measure 

real	0m48.016s
user	0m47.460s
sys	0m0.330s

50000:

hamilyon@coordinator:~/re/freb$ time ./Measure 

real	2m53.707s
user	2m52.480s
sys	0m0.350s

50000:

hamilyon@coordinator:~/re/freb$ time ./Measure 

real	3m1.701s
user	2m57.550s
sys	0m0.420s

100000:

hamilyon@coordinator:~/re/freb$ time ./Measure 

real	27m49.089s
user	11m33.590s
sys	0m0.780s


200000:
hamilyon@coordinator:~/re/freb$ time ./Measure 


real	130m45.922s
user	33m50.980s
sys	0m1.330s


f2eebccae0493b11768402d4d8d1ca7e5e13b752:
initial spam train lengths 235997
initial ham  train lengths 239911
spamDict : 
quantiles = [1,4,5,8,61]
mean = 6.13013013013013
length = 2997
hamDict : 
quantiles = [1,5,7,9,21]
mean = 6.94306778619701
length = 4883

Stats {overallSpam = 3500, overallHam = 187, detectedSpamOk = 738, detectedHamOk = 173, detectedFalseSpam = 14, detecteFalseHam = 2762}
Stats {overallSpam = 3500, overallHam = 187, detectedSpamOk = 738, detectedHamOk = 173, detectedFalseSpam = 14, detecteFalseHam = 2762}

По результатам первой итерации видно:
много слов, вроде однобуквенных и html тэгов успешно натренировались и считаются спамом
    предположение: знание о структуре поможет считать её несущественной

алгоритм в целом работает верно
результаты плохие, гипотез по поводу того, что это вызывает, нет: низкая видимость процесса тренировки/проверки не дает заглянуть

разброс длин слов в тестовом наборе очень большой
средняя длина слова очень большая

разные кодировки не поддерживаются

возможна стадия препроцессинга, когда все не похожее на utf-8 английский текст, отбрасывается.
    это можно реализовать с помощью частотного анализа. Дешево и сердито.

Парсер разметки письма справляется успешно.

План: найти группу из 10 сообщений, в которых особенно без успешно определяется спам.
Прочитать их вручную.


нашел. ПРоверяю гипотезу, что статистически чаще всего сообщение, 
которое определяется ошибочно как хам представляет собой просто мусор 
(base64, 7-битная сжатая куча мусора) что представляет собой определенную 
трудность. 

Проверяю гипотезу: мусор можно фильтровать обычным частотным фильтрои.
Так же отфильтруются сообщения не на англйском.


Проверил.
У не-мусора корреляция частотного вектора с частотным вектором
статей на английском языке [0.29, 1]

Итеративно (со 2 итерации)

Взял 849 спам-сообщений и строю их сумматрый частотный вектор.
normalize . dropSpace . frequency т.е. единственное что подхачил - убрал пробелы.

Более 10 минут занимает процесс вычисления. (неоптимально считаю ?)

пришел к вектору

typicalSpam = Map.fromList [('\t',8.580503187410604e-3),('\n',0.11644877066588909),
    ('\f',9.61221417559067e-6),('\r',1.313669270664058e-4),('\ESC',2.5632571134908452e-5),('!',7.7314242685667615e-3),('"',0.14057542824662167),('#',1.0525374522271782e-2),('$',1.445036197730464e-3),('%',1.4706687688653723e-3),('&',4.219762023084304e-3),('\'',2.925317180771427e-3),('(',3.1303777498506943e-3),(')',3.204071391863556e-3),('*',4.60425059010793e-3),('+',7.561608484797993e-4),(',',2.162107375229528e-2),('-',9.04765679634431e-2),('.',8.634011179654726e-2),('/',0.17116469782474303),('0',0.10406183066494458),('1',5.1120959057183044e-2),('2',3.951260840446138e-2),('3',6.605193174326722e-2),('4',1.6734864879703354e-2),('5',1.635037631267973e-2),('6',3.236112105782192e-2),('7',8.586911330194331e-3),('8',1.4607361475505953e-2),('9',2.8682847099962556e-2),(':',0.1250196616391241),(';',3.754210449846529e-2),('<',8.947689768918167e-2),('=',0.13187957848910398),('>',8.954097911701894e-2),('?',2.8932764668527914e-3),('@',3.8256612418850863e-3),('A',2.2864253452338338e-2),('B',1.623502974257264e-2),('C',2.7285871973110044e-2),('D',6.385714283984067e-2),('E',2.240607124330185e-2),('F',1.726353665936084e-2),('G',3.8512938130199946e-3),('H',1.254073542775396e-2),('I',8.715074185868874e-3),('J',8.554870616275695e-4),('K',1.2303634144756057e-3),('L',1.2880366995291496e-2),('M',1.7619188583857696e-2),('N',1.4642606260816452e-2),('O',1.4530463762101228e-2),('P',1.261442906976682e-2),('Q',1.1054046301929269e-3),('R',1.3521181273664208e-2),('S',1.7558311227412287e-2),('T',3.0457902651054965e-2),('U',4.972718800172239e-3),('V',6.106960072891938e-3),('W',5.985205360001123e-3),('X',2.1050749044543566e-3),('Y',5.834614004583536e-3),('Z',1.6725252665527764e-3),('[',3.16241846376933e-3),('\\',9.61221417559067e-6),(']',3.156010320985603e-3),('^',2.5952978274094805e-4),('_',8.952175468866777e-3),('`',5.1265142269816904e-5),('a',0.2453517668319518),('b',5.9820012886092594e-2),('c',0.18931896633104195),('d',0.11954069955903743),('e',0.35828246710957473),('f',0.11406814562173447),('g',6.840372014489507e-2),('h',0.13436273381779823),('i',0.24849496086736997),('j',3.578947744711592e-3),('k',1.917316320891152e-2),('l',0.19581682311374124),('m',0.175720887343973),('n',0.2261177262665949),('o',0.3026886243893502),('p',0.14585253382902094),('q',5.780144790921856e-3),('r',0.23044963078839442),('s',0.28765512141872634),('t',0.33303438454168993),('u',7.60486344858815e-2),('v',3.536654002338994e-2),('w',5.659351299448599e-2),('x',7.040306069341792e-2),('y',5.919201489328734e-2),('z',8.872073684070187e-3),('{',5.4981865084378625e-3),('|',9.003440611136594e-4),('}',5.501390579829726e-3),('~',9.61221417559067e-6),('\145',6.408142783727113e-6),('\146',6.408142783727113e-6),('\163',3.2040713918635565e-6),('\169',1.6020356959317782e-5),('\183',9.61221417559067e-5),('\237',3.2040713918635565e-6),('\243',3.2040713918635565e-6),('\1042',9.61221417559067e-6),('\1050',6.408142783727113e-6),('\1053',3.2040713918635565e-6),('\1065',3.2040713918635565e-6),('\1072',4.1652928094226234e-5),('\1073',6.408142783727113e-6),('\1074',1.2816285567454226e-5),('\1076',1.6020356959317782e-5),('\1077',1.6020356959317782e-5),('\1078',3.2040713918635565e-6),('\1079',3.2040713918635565e-6),('\1080',2.2428499743044895e-5),('\1081',6.408142783727113e-6),('\1082',3.2040713918635565e-6),('\1083',1.6020356959317782e-5),('\1084',2.2428499743044895e-5),('\1085',2.2428499743044895e-5),('\1086',3.2040713918635565e-5),('\1087',1.6020356959317782e-5),('\1088',1.2816285567454226e-5),('\1089',9.61221417559067e-6),('\1090',2.2428499743044895e-5),('\1091',6.408142783727113e-6),('\1096',3.2040713918635565e-6),('\1100',6.408142783727113e-6),('\1103',9.61221417559067e-6),('\1110',1.6020356959317782e-5),('\8364',8.01017847965889e-5)]

Если фильтровать уже этим вектором, имеем например, следующее:
("../corpi/test_data/spam/test/1287800698.28245_473.lorien",0.6127243372558953)
А это сообщение из одной ссылки:
http://pharmacyyg23.com

Или вот:
("../corpi/test_data/spam/test/1287753131.12825_299.lorien",0.5970740994450029)
http://pharmacyyg11.com

т.о.
можно фильтровать по частотному вектору, чтобы отсеять явный мусор

for reference:
correlation typicalEnglish typicalSpam
0.3356743583819539


